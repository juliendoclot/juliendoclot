---
export const prerender = true;

import { getCollection } from 'astro:content';
import { Image } from 'astro:assets';
import Layout from '../layouts/Layout.astro';
import BlogCard from '../components/BlogCard.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../consts';

// Get all posts
const allPosts = (await getCollection('blog'))
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Get the latest post for hero
const latestPost = allPosts[0];

// Get the next 5 posts for the grid
const posts = allPosts.slice(1, 6);

// Get all unique categories from posts
const categories = [...new Set(allPosts.flatMap((post) => post.data.tags))];

---

<Layout title={SITE_TITLE} description={SITE_DESCRIPTION}>
	<!-- Hero Section - Latest Article -->
	<a href={`/blog/${latestPost.id}/`} class="block hero-gradient px-6 sm:px-10 lg:px-16 py-16 md:py-24 rounded-3xl mb-16 relative no-underline group overflow-hidden" style="-webkit-mask-image: -webkit-radial-gradient(white, black);">
		<!-- Hero Image Background -->
		{latestPost.data.heroImage && (
			<Image
				src={latestPost.data.heroImage}
				alt={latestPost.data.title}
				width={1200}
				height={600}
				class="absolute inset-0 w-full h-full object-cover opacity-70 group-hover:opacity-80 group-hover:scale-105 transition-all duration-500 blur-[1px] rounded-3xl"
			/>
		)}
		<!-- Dark overlay -->
		<div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-[#0f172a]/80 to-transparent rounded-3xl" />
		<!-- Light beams -->
		<div class="light-beam"></div>

		<div class="relative z-10">
			<p class="text-indigo-400 text-sm font-medium tracking-wide uppercase mb-4">Dernier article</p>
			<h1 class="text-4xl md:text-5xl lg:text-6xl font-bold text-white mb-6 leading-[1.1] tracking-tight group-hover:text-indigo-200 transition-colors">
				{latestPost.data.title}
			</h1>
			<p class="text-gray-400 text-lg md:text-xl max-w-2xl leading-relaxed mb-6">
				{latestPost.data.description}
			</p>
			<div class="flex items-center gap-4">
				<span class="px-3 py-1 rounded-full bg-indigo-500/20 text-indigo-300 text-sm font-medium">
					{latestPost.data.tags?.[0]}
				</span>
				<span class="text-gray-500 text-sm">
					{latestPost.data.pubDate.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' })}
				</span>
			</div>
		</div>
	</a>

	<!-- Latest Articles Section -->
	<section class="py-4">
		<h2 class="text-3xl md:text-4xl font-bold mb-10 text-gray-900 dark:text-white">
			Derniers Articles
		</h2>

		<!-- Categories Filter + Search -->
		<div class="flex flex-wrap items-center gap-3 mb-10">
			<div id="categories-filter" class="flex flex-wrap items-center gap-3">
				<span class="tag-pill active" data-tag="all">Tous</span>
				{categories.map((category) => (
					<span class="tag-pill" data-tag={category}>{category}</span>
				))}
			</div>

			<!-- Search input -->
			<div class="relative ml-auto">
				<svg class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
				</svg>
				<input
					id="search-input"
					type="text"
					placeholder="Rechercher"
					class="pl-11 pr-4 py-2.5 rounded-full border border-gray-200 dark:border-gray-700 bg-white dark:bg-transparent text-sm text-gray-600 dark:text-gray-400 placeholder-gray-400 focus:outline-none focus:border-indigo-400 focus:ring-1 focus:ring-indigo-400 transition-all w-40 focus:w-56"
				/>
			</div>
		</div>

		<!-- Posts Grid -->
		<div id="posts-grid" class="grid md:grid-cols-2 gap-8">
			{posts.map((post) => (
				<div class="post-item" data-tags={JSON.stringify(post.data.tags || [])} data-title={post.data.title.toLowerCase()} data-description={post.data.description?.toLowerCase() || ''}>
					<BlogCard post={post} />
				</div>
			))}
		</div>

		<!-- View all link -->
		<div class="text-center mt-12">
			<a
				href="/blog"
				class="inline-flex items-center gap-2 px-8 py-3 rounded-full border border-gray-300 dark:border-gray-700 text-gray-700 dark:text-gray-300 font-medium hover:border-indigo-500 hover:text-indigo-600 dark:hover:text-indigo-400 transition-all no-underline"
			>
				Voir tous les articles
				<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
				</svg>
			</a>
		</div>
	</section>
</Layout>

<script>
	const categoriesFilter = document.getElementById('categories-filter');
	const searchInput = document.getElementById('search-input') as HTMLInputElement;
	const postItems = document.querySelectorAll('#posts-grid .post-item');

	let activeTag = 'all';
	let searchQuery = '';

	function filterPosts() {
		postItems.forEach(item => {
			const el = item as HTMLElement;
			const postTags = JSON.parse(el.dataset.tags || '[]');
			const title = el.dataset.title || '';
			const description = el.dataset.description || '';

			const matchesTag = activeTag === 'all' || postTags.includes(activeTag);
			const matchesSearch = !searchQuery ||
				title.includes(searchQuery) ||
				description.includes(searchQuery) ||
				postTags.some((tag: string) => tag.toLowerCase().includes(searchQuery));

			el.style.display = matchesTag && matchesSearch ? '' : 'none';
		});
	}

	categoriesFilter?.addEventListener('click', (e) => {
		const target = e.target as HTMLElement;
		if (!target.classList.contains('tag-pill')) return;

		categoriesFilter.querySelectorAll('.tag-pill').forEach(pill => pill.classList.remove('active'));
		target.classList.add('active');

		activeTag = target.dataset.tag || 'all';
		filterPosts();
	});

	searchInput?.addEventListener('input', () => {
		searchQuery = searchInput.value.toLowerCase().trim();
		filterPosts();
	});
</script>
